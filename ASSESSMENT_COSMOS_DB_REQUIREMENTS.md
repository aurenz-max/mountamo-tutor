# Assessment Storage - Cosmos DB Requirements

## Overview
The current assessment system generates assessment data on the backend but doesn't persist it, causing issues when students navigate to take assessments. We need to implement Cosmos DB storage for assessments to enable proper data persistence and retrieval.

## Current Issue
- Assessment is created successfully on backend (200 OK response)
- Assessment data is only passed via frontend navigation state
- When user navigates to `/assessments/take/{assessment_id}`, the data is not available
- Frontend shows "Assessment Not Found" error

## Required Implementation

### 1. Cosmos DB Container Setup

**Container Name:** `assessments`

**Partition Key:** `/student_id` (for optimal query performance by student)

**Sample Document Schema:**
```json
{
  "id": "assess_1004_Mathematics_1758059693",
  "assessment_id": "assess_1004_Mathematics_1758059693",
  "student_id": 1004,
  "subject": "Mathematics",
  "status": "created", // created, in_progress, completed, expired
  "total_questions": 15,
  "estimated_duration_minutes": 30,
  "blueprint": {
    "category_breakdown": {
      "algebra": 5,
      "geometry": 4,
      "statistics": 6
    },
    "total_available_subskills": 45,
    "is_cold_start": false
  },
  "problems": [
    // Array of problem objects as generated by AssessmentService
  ],
  "created_at": "2025-01-16T10:30:00Z",
  "expires_at": "2025-01-16T16:30:00Z", // 6 hours from creation
  "started_at": null,
  "completed_at": null,
  "answers": null, // Will be populated when submitted
  "score_data": null, // Will be populated when scored
  "time_taken_minutes": null,
  "_ts": 1737024600
}
```

### 2. Backend Service Updates

#### A. Update `AssessmentService` class

**File:** `backend/app/services/assessment_service.py`

**New Methods Required:**

1. **`store_assessment(assessment_data: dict) -> bool`**
   - Store assessment data in Cosmos DB
   - Set expiration time (6 hours from creation)
   - Handle duplicate ID errors gracefully

2. **`get_assessment(assessment_id: str, student_id: int) -> dict`**
   - Retrieve assessment by ID
   - Validate student has access to this assessment
   - Return None if not found or expired

3. **`update_assessment_status(assessment_id: str, status: str) -> bool`**
   - Update assessment status (created → in_progress → completed)
   - Update timestamps accordingly

4. **`store_assessment_submission(assessment_id: str, answers: dict, score_data: dict) -> bool`**
   - Store student answers and scoring results
   - Mark assessment as completed

#### B. Update Assessment Endpoints

**File:** `backend/app/api/endpoints/assessments.py`

**Endpoint Updates:**

1. **`POST /{subject}` (create assessment)**
   ```python
   # After generating assessment data:
   await assessment_service.store_assessment(assessment)
   ```

2. **`GET /{assessment_id}` (NEW ENDPOINT)**
   ```python
   @router.get("/{assessment_id}")
   async def get_assessment(
       assessment_id: str,
       user_context: dict = Depends(get_user_context),
       assessment_service: AssessmentService = Depends(get_assessment_service)
   ) -> AssessmentResponse:
       """Retrieve assessment data for taking the assessment"""
   ```

3. **`POST /{subject}/submit` (update existing)**
   ```python
   # After scoring:
   await assessment_service.store_assessment_submission(
       assessment_id, answers, submission_result
   )
   ```

### 3. Frontend Updates Required

#### A. Update Assessment Navigation
**File:** `my-tutoring-app/src/app/assessments/page.tsx`

Remove router state passing, just navigate:
```typescript
router.push(`/assessments/take/${assessmentData.assessment_id}`);
```

#### B. Update Assessment Take Page
**File:** `my-tutoring-app/src/app/assessments/take/[assessment_id]/page.tsx`

Add API call to fetch assessment:
```typescript
useEffect(() => {
  const fetchAssessment = async () => {
    try {
      const data = await authApi.getAssessment(assessmentId);
      setAssessmentData(data);
    } catch (error) {
      setError('Assessment not found or expired');
    }
    setLoading(false);
  };

  if (assessmentId && user) {
    fetchAssessment();
  }
}, [assessmentId, user]);
```

#### C. Add API Client Method
**File:** `my-tutoring-app/src/lib/authApiClient.ts`

```typescript
async getAssessment(assessmentId: string) {
  return this.get(`/api/assessments/${assessmentId}`);
}
```

### 4. Configuration Updates

#### A. Cosmos DB Connection
Ensure Cosmos DB client is configured with:
- Database: existing database
- Container: `assessments`
- Partition key: `/student_id`

#### B. TTL Configuration
Set up automatic document expiration:
- TTL field: `ttl` (seconds from creation)
- Default: 21600 seconds (6 hours)

### 5. Error Handling & Edge Cases

1. **Assessment Not Found**: Return 404 with clear message
2. **Assessment Expired**: Return 410 Gone with expiration message
3. **Access Denied**: Ensure student can only access their own assessments
4. **Duplicate Creation**: Handle gracefully if assessment ID already exists
5. **Cosmos DB Unavailable**: Fallback to memory storage with warning

### 6. Testing Requirements

1. **Unit Tests**:
   - Assessment storage and retrieval
   - Access control validation
   - Expiration handling

2. **Integration Tests**:
   - End-to-end assessment creation → storage → retrieval → submission flow
   - Error scenarios (expired, not found, access denied)

3. **Load Testing**:
   - Concurrent assessment creation
   - High-volume assessment retrieval

### 7. Monitoring & Logging

1. **Metrics to Track**:
   - Assessment creation rate
   - Assessment retrieval success rate
   - Assessment expiration rate
   - Storage operation latency

2. **Log Events**:
   - Assessment stored successfully
   - Assessment retrieval attempts
   - Access denied events
   - Expiration cleanups

### 8. Migration Considerations

- This is a new feature, no data migration needed
- Existing assessment flow will be enhanced, not replaced
- Backward compatibility with current frontend until updates deployed

## Priority & Timeline

**Priority**: High (blocking current assessment functionality)

**Estimated Effort**:
- Backend: 1-2 days
- Testing: 1 day
- Documentation: 0.5 days

**Dependencies**:
- Cosmos DB container creation
- Backend service updates
- Frontend API integration updates

## Success Criteria

1. Students can create an assessment and navigate to it successfully
2. Assessment data persists across browser refreshes
3. Assessments automatically expire after 6 hours
4. Students cannot access other students' assessments
5. All assessment operations are properly logged and monitored